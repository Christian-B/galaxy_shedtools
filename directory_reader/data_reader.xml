<tool id="directory_data_reader_script" name="Directory Data Finder" version="0.1">
    <description>Reads a particular data type from a directory on the server</description>
    <command interpreter="python">
<![CDATA[
        directory_copier.py  
        #if $results.required=="data"
            --ending .${results.extension.file_type} 
            --link
            #if $results.start
                --start $results.start
            #end if      
            #if $results.last
                --last $results.last
            #end if      
            #if $results.extension.file_type=="text"
                --new_ending .txt
            #end if
            #if $results.extension.file_type=="tsv"
                --new_ending .tabular
            #end if
            #if $results.extension.file_type in ["fasta.gz","fastq.gz"]
                #if $results.extension.decompress.doit=="yes"
                    --decompress
                #end if
            #end if
            #if $results.extension.file_type=="fastq"
                --new_ending .$results.extension.new_galaxy.new_ending
            #end if
            #if $results.extension.file_type=="fastq.gz"
                #if $results.extension.decompress.doit=="yes"
                    --new_ending .${results.extension.new_galaxy.new_ending}
                #else
                    --new_ending .${results.extension.new_galaxy.new_ending}.gz
                #end if
            #end if
        #else
            --ending bam 
            --ending csv 
            --ending fasta 
            --ending fasta.gz 
            --ending fastq 
            --ending fastq.gz 
            --ending sam 
            --ending tabular 
            --ending text 
            --ending tsv 
            --ending txt 
            --ending xls 
            --ending xlsx
        #end if      
        #if $directory.startswith('/'):
            --path ${directory}
        #else
            --path $__tool_directory__/${directory}
        #end if      
        --list ${listing}
]]>
    </command>
    <inputs>
        <param name="directory" type="text" label="Directory to read data from." />
        <param name="list_name" type="text" size="25" label="output name" value="input data"/>
        <conditional name="results">
            <param name="required" type="select" label="Download data or just directory listing" help="Select type of action required.">
                <option value="data" selected="true">Data and listing of selected type</option>
                <option value="listing">Get listing of selected file types </option>
            </param>
            <when value="data">
                <param name="start" type="text" value="" label="String which must be at the start of each file name" />
                <param name="last" type="text" value="" label="String which must be at the end of the file name (excluding the file type)" />
                <conditional name="extension">
                    <param name="file_type" type="select" label="File Type" help="File Type.">
                        <option value="bam">*.bam files</option>
                        <option value="csv">*.csv files</option>
                        <option value="fasta">*.fatsa files</option>
                        <option value="fasta.gz">*.fatsa.gz files</option>
                        <option value="fastq">*.fastq files</option>
                        <option value="fastq.gz">*.fastq.gz files</option>
                        <option value="fastq">*.fastq files</option>
                        <option value="fastq.gz">*.fastq.gz files</option>
                        <option value="sam">*.sam files</option>
                        <option value="tabular">*.tabular Files</option>
                        <option value="text">*.text Files saved as *.txt for galaxy</option>
                        <option value="tsv">*.tsv files saved as *.tabular for galaxy</option>
                        <option value="txt">*.txt Files</option>
                        <option value="xls">*.xls files</option>
                        <option value="xlsx">*.xlsx files</option>
                    </param>
                    <when value="csv" />
                    <when value="fasta" />
                    <when value="fasta.gz" >
                        <conditional name="decompress">
                            <param name="doit" type="select" label="Decompress data" help="If selected will decompress the data.">
                                <option value="yes" selected="true">Yes decompress and change the extension to *.fasta</option>
                                <option value="no">No copy as is.</option>
                            </param>
                        </conditional>
                    </when>
                    <when value="fastq" >
                        <conditional name="new_galaxy">
                            <param name="new_ending" type="select" label="Ending to be used for Galaxy" help="Will detetmine which down stream tools can be used.">
                                <option value="fastq" selected="true">Keep data as general fastq format</option>
                                <option value="fastqsanger">Tag data as fastq sanger in galaxy</option>
                                <option value="fastqsolexa">Tag data as fastq solexa in galaxy</option>
                                <option value="fastqsolexaillumina">Tag data as fastq illumina in galaxy</option>
                             </param>
                        </conditional>
                    </when>
                    <when value="fastq.gz" >
                        <conditional name="decompress">
                            <param name="doit" type="select" label="Decompress data" help="If selected will decompress the data.">
                                <option value="yes" selected="true">Yes decompress and change the extension to *.fasta</option>
                                <option value="no">No copy as is.</option>
                            </param>
                        </conditional>
                        <conditional name="new_galaxy">
                            <param name="new_ending" type="select" label="Ending to be used for Galaxy" help="Will detetmine which down stream tools can be used.">
                                <option value="fastq" selected="true" >Keep data as general fastq format</option>
                                <option value="fastqsanger">Tag data as fastq sanger in galaxy</option>
                                <option value="fastqsolexa">Tag data as fastq solexa in galaxy</option>
                                <option value="fastqsolexaillumina">Tag data as fastq illumina in galaxy</option>
                             </param>
                        </conditional>
                    </when>
                    <when value="sam" />
                    <when value="tabular" />
                    <when value="text" />
                    <when value="tsv" />
                    <when value="txt" />
                    <when value="xls" />
                    <when value="xlsx" />
                </conditional>
            </when>
            <when value="listing">
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="txt" name="listing" label="List of files in $list_name">
        </data>
        <!-- Ideally galaxy can get the type based on the file extensions. If so just add the type here -->
        <collection type="list" label="$list_name" name="as_galaxy_list">
            <filter>(results['required'] == 'data')</filter>
            <filter>(results['extension']['file_type'] in ['bam','csv','fasta','fastq','sam','tabular','text','tsv','txt','xls','xlsx'])</filter>
                <discover_datasets pattern="__designation_and_ext__" directory="output" visible="true" />
        </collection>
        <collection type="list" label="$list_name" name="decompressed_list">
            <filter>(results['required'] == 'data')</filter>
            <filter>(results['extension']['file_type'] in ['fasta.qz','fastq.gz'])</filter>
            <filter>(results['extension']['decompress']['doit'] == "yes")</filter>
                <discover_datasets pattern="__designation_and_ext__" directory="output" visible="true" />
        </collection>
        <!-- The .gz at the end of a compressed file is useful for the user but confuses galaxy -->
        <collection type="list" label="$list_name" name="gz_list">
            <filter>(results['required'] == 'data')</filter>
            <filter>(results['extension']['file_type']in ['fasta.gz','fastq.gz'])</filter>
            <filter>(results['extension']['decompress']['doit']  == "no")</filter>
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.(?P&lt;ext&gt;.+).gz" directory="output" visible="true" />
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="directory" value="test-data" />
            <param name="list_name" value="csv_files" />
            <param name="results|extension|file_type" value="csv"/>
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.csv" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="csv" file="sample1.csv" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="fasta"/>
            <param name="results|start" value="sam" />
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.fasta" />
                    <not_has_text text="other.fasta" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="fasta" file="sample1.fasta" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="fasta.gz"/>
            <param name="results|extension|decompress|doit" value="no"/>
            <param name="results|last" value="le1" />
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.fasta.gz" />
                    <not_has_text text="other.fasta.gz" />
                </assert_contents>
            </output>
            <output_collection name="gz_list" type="list">
                <element name="sample1" ftype="fasta" file="sample1.fasta.gz" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="fastq"/>
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.fastq" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="fastq" file="sample1.fastq" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="fastq"/>
            <param name="results|extension|new_galaxy|new_ending" value="fastqsanger"/>
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.fastqsanger" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="fastqsanger" file="sample1.fastq" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="fastq.gz"/>
            <param name="results|extension|decompress|doit" value="no"/>
            <output name="listing_fastq_gz">
                <assert_contents>
                    <has_line line="sample1.fastq.gz" />
                </assert_contents>
            </output>
            <output_collection name="gz_list" type="list">
                <element name="sample1" ftype="fastq" file="sample1.fastq.gz" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="fastq.gz"/>
            <param name="results|extension|decompress|doit" value="yes"/>
            <param name="results|extension|new_galaxy|new_ending" value="fastqsanger"/>
            <output name="listing_fastq_gz">
                <assert_contents>
                    <has_line line="sample1.fastqsanger" />
                </assert_contents>
            </output>
            <output_collection name="decompressed_list" type="list">
                <element name="sample1" ftype="fastqsanger" file="sample1.fastq" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="fastq.gz"/>
            <param name="results|extension|decompress|doit" value="no"/>
            <param name="results|extension|new_galaxy|new_ending" value="fastqsanger"/>
            <output name="listing_fastq_gz">
                <assert_contents>
                    <has_line line="sample1.fastqsanger.gz" />
                </assert_contents>
            </output>
            <output_collection name="gz_list" type="list">
                <element name="sample1" ftype="fastqsanger" file="sample1.fastq.gz" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="fastq.gz"/>
            <param name="results|extension|new_galaxy|new_ending" value="fastqsanger"/>
            <param name="results|extension|decompress|doit" value="yes"/>
            <output name="listing_fastq_gz">
                <assert_contents>
                    <has_line line="sample1.fastqsanger" />
                </assert_contents>
            </output>
            <output_collection name="decompressed_list" type="list">
                <element name="sample1" ftype="fastqsanger" file="sample1.fastq" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="sam"/>
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.sam" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="sam" file="sample1.sam" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="tabular"/>
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.tabular" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="tabular" file="sample1.tabular" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="text"/>
            <output name="listing_text">
                <assert_contents>
                    <has_line line="sample1.txt" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="txt" file="sample1.text" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="tsv"/>
            <output name="as_galaxy_list">
                <assert_contents>
                    <has_line line="sample1.tabular" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="tabular" file="sample1.tsv" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="txt" />
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.txt" />
                </assert_contents>cd 
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="txt" file="sample1.txt" />
                <element name="sample2" ftype="txt" file="sample2.txt" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="xls"/>
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.xls" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="xls" file="sample1.xls" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|extension|file_type" value="xlsx"/>
            <output name="listing">
                <assert_contents>
                    <has_line line="sample1.xlsx" />
                </assert_contents>
            </output>
            <output_collection name="as_galaxy_list" type="list">
                <element name="sample1" ftype="xlsx" file="sample1.xlsx" />
           </output_collection>
        </test>
        <test>
            <param name="directory" value="test-data" />
            <param name="results|required" value="listing"/>
            <output name="listing_all">
                <assert_contents>
                    <has_line line="sample1.csv" />
                    <has_line line="sample1.fasta" />
                    <has_line line="sample1.fasta.gz" />
                    <has_line line="sample1.fastq" />
                    <has_line line="sample1.fastq.gz" />
                    <has_line line="sample1.sam" />
                    <has_line line="sample1.tabular" />
                    <has_line line="sample1.text" />
                    <has_line line="sample1.tsv" />
                    <has_line line="sample1.txt" />
                    <has_line line="sample1.xls" />
                    <has_line line="sample1.xlsx" />
                 </assert_contents>
            </output>
        </test>

    </tests>

    <help>
<![CDATA[
    Reads data of a particuar extension
]]>
    </help>
    <citations>
    </citations>

</tool>
